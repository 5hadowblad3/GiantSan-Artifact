#!/usr/bin/make -f
# -*- Makefile -*- debian/rules for autotrace

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export DEB_HOST_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
export DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

# FOR AUTOCONF 2.52 AND NEWER ONLY
ifeq ($(DEB_BUILD_GNU_TYPE), $(DEB_HOST_GNU_TYPE))
  confflags += --build $(DEB_HOST_GNU_TYPE)
else
  confflags += --build $(DEB_BUILD_GNU_TYPE) --host $(DEB_HOST_GNU_TYPE)
endif

CFLAGS = -Wall -g
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
  CFLAGS += -O0
else
  CFLAGS += -O2
endif

# The 'autotools' target makes sure that the files not in my cvs
# repository are up-to-date before building. The autotools-dev package
# supplies fresh config.{guess,sub} files; this makes buildds
# happy. Other autogenerated files are remade only if they don't
# exist. Since they *are* in the .diff.gz, buildds will not run
# autoconf etc, but it does happen when cvs-buildpackage runs
# dpkg-buildpackage to create a fresh .diff.gz file.
autotools: autotools-stamp
autotools-stamp:
	dh_testdir
	[ -f ltmain.sh ]   || libtoolize -c -f --automake
	-rm -f config.sub config.guess
	ln -s /usr/share/misc/config.sub config.sub
	ln -s /usr/share/misc/config.guess config.guess
	[ -f aclocal.m4 ]  || aclocal -I debian
	[ -f config.h.in ] || autoheader
	[ -f Makefile.in ] || automake
	[ -f configure ]   || autoconf
	touch autotools-stamp

configure: configure-stamp
configure-stamp: autotools-stamp
	./configure CFLAGS="$(CFLAGS)" $(confflags) \
		--without-ming \
		--prefix=/usr --mandir=\$${prefix}/share/man
	touch configure-stamp
# Check that all libraries are detected correctly
	grep 'define HAVE_MAGICK 1' config.h
	grep 'define HAVE_LIBPNG 1' config.h
	grep 'undef HAVE_LIBSWF' config.h
	grep 'define HAVE_LIBPSTOEDIT 1' config.h

# Override the autodetected pstoedit flags until pstoedit-dev
# starts shipping a sane pkg-config definition.
build: configure-stamp
	dh_testdir
	$(MAKE) LIBPSTOEDIT_LIBS=-lpstoedit

clean: autotools-stamp
	[ -z "`find -uid 0`" ] || dh_testroot
	rm -f configure-stamp autotools-stamp
	[ ! -f Makefile ] || $(MAKE) distclean
	rm -f config.sub config.guess
	rm -f sample.c
	dh_clean

install: build
	dh_testroot
	dh_clean -k
	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp
	dh_install --sourcedir=debian/tmp

# Build architecture-independent files here.
binary-indep: install
# We have nothing to do by default.

sample.c:
	sed '1,/\* sample.c \*/d' README | sed '/^[^ ]/,$$d' > $@
	[ -s $@ ]

# Build architecture-dependent files here.
binary-arch: install sample.c
	dh_installdocs -pautotrace -plibautotrace3 NEWS THANKS
	dh_installdocs -plibautotrace-dev
	dh_installexamples -plibautotrace-dev sample.c
	dh_installchangelogs ChangeLog
	dh_strip
	dh_compress
	dh_fixperms
	dh_makeshlibs -plibautotrace3
	dh_installdeb
	dh_shlibdeps -Llibautotrace3 -ldebian/libautotrace3/usr/lib
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
.PHONY: autotools
